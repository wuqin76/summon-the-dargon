# ðŸ”§ æŠ½å¥–æ¬¡æ•°æ•°æ®ä¸ä¸€è‡´ä¿®å¤æ–¹æ¡ˆ

## ðŸ“Š é—®é¢˜åˆ†æž

### ä½ é‡åˆ°çš„é—®é¢˜ï¼š

- âœ… æ•°æ®åº“ `users` è¡¨æ˜¾ç¤ºï¼š`available_spins = 10`
- âŒ å‰ç«¯æ˜¾ç¤ºï¼š`å¯æŠ½å¥–æ¬¡æ•°: 0`
- âŒ ç‚¹å‡»æŠ½å¥–æç¤ºï¼š"æ²¡æœ‰å¯ç”¨çš„æŠ½å¥–æœºä¼š"

### æ ¹æœ¬åŽŸå› ï¼š

ç³»ç»Ÿä½¿ç”¨**ä¸¤ä¸ªåœ°æ–¹**å­˜å‚¨æŠ½å¥–æ¬¡æ•°ï¼š

1. **`users` è¡¨çš„ `available_spins` å­—æ®µ** - ä»…ç”¨äºŽç»Ÿè®¡æ˜¾ç¤º
2. **`spin_entitlements` è¡¨** - çœŸæ­£å†³å®šèƒ½å¦æŠ½å¥–çš„èµ„æ ¼è®°å½•

```
çœŸå®žé€»è¾‘ï¼š
å‰ç«¯æ˜¾ç¤º â† APIæŸ¥è¯¢ â† spin_entitlements è¡¨ï¼ˆWHERE consumed=falseï¼‰
                  â†‘
                  çœŸæ­£çš„æ•°æ®æºï¼
```

ä½ çš„æƒ…å†µï¼š

- `users.available_spins = 10` âœ…ï¼ˆç»Ÿè®¡å­—æ®µæœ‰æ•°æ®ï¼‰
- `spin_entitlements` è¡¨é‡Œ**æ²¡æœ‰è®°å½•** âŒï¼ˆæ²¡æœ‰çœŸæ­£çš„æŠ½å¥–èµ„æ ¼ï¼‰

## ðŸ› ï¸ å·²å®žçŽ°çš„ä¿®å¤æ–¹æ¡ˆ

### 1. è‡ªåŠ¨åŒæ­¥æ£€æµ‹ï¼ˆåŽç«¯ï¼‰

ä¿®æ”¹äº† `spin_v2.routes.ts`ï¼š

```typescript
// GET /api/spin/available
// æ¯æ¬¡æŸ¥è¯¢æ—¶è‡ªåŠ¨æ£€æµ‹å¹¶ä¿®å¤æ•°æ®ä¸ä¸€è‡´
if (availableCount !== userSpins) {
  // è‡ªåŠ¨ä»¥ spin_entitlements ä¸ºå‡†ï¼ŒåŒæ­¥ users è¡¨
  await pool.query("UPDATE users SET available_spins = $1 WHERE id = $2", [
    availableCount,
    userId,
  ]);
}
```

### 2. æ‰‹åŠ¨ä¿®å¤å·¥å…·ï¼ˆå¼€å‘è€…é¢æ¿ï¼‰

æ–°å¢ž API å’Œå‰ç«¯æŒ‰é’®ï¼š

**åŽç«¯æŽ¥å£ï¼š**

```
POST /api/dev/sync-spins
```

**å‰ç«¯æŒ‰é’®ï¼š**

```
ðŸ”§ ä¿®å¤æŠ½å¥–æ¬¡æ•°
```

åŠŸèƒ½ï¼š

- å¦‚æžœ `users.available_spins > spin_entitlements count`
  â†’ åˆ›å»ºç¼ºå¤±çš„ `spin_entitlements` è®°å½•
- å¦‚æžœ `users.available_spins < spin_entitlements count`
  â†’ æ›´æ–° `users.available_spins` å€¼

## ðŸŽ¯ å¦‚ä½•ä½¿ç”¨ä¿®å¤å·¥å…·

### æ–¹æ³•1ï¼šè‡ªåŠ¨ä¿®å¤ï¼ˆæŽ¨èï¼‰

åªéœ€åˆ·æ–°é¡µé¢æˆ–ç‚¹å‡»æŠ½å¥–æŒ‰é’®ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å¹¶åŒæ­¥æ•°æ®ã€‚

### æ–¹æ³•2ï¼šæ‰‹åŠ¨ä¿®å¤

1. æ‰“å¼€ Telegram Bot
2. ç‚¹å‡» **"ðŸ› ï¸ å¼€å‘è€…"** æŒ‰é’®
3. ç‚¹å‡» **"ðŸ”§ ä¿®å¤æŠ½å¥–æ¬¡æ•°"** æŒ‰é’®
4. æŸ¥çœ‹ä¿®å¤ç»“æžœ
5. å…³é—­é¢æ¿ï¼Œåˆ·æ–°é¡µé¢

## ðŸ“ é¢„é˜²æŽªæ–½

### ä¿®æ”¹åŽçš„æ‰€æœ‰åˆ›å»ºæŠ½å¥–æœºä¼šçš„åœ°æ–¹éƒ½ä¼šåŒæ—¶æ“ä½œä¸¤ä¸ªè¡¨ï¼š

1. **é‚€è¯·å¥½å‹æˆåŠŸ**

   ```sql
   -- åŒæ—¶æ‰§è¡Œ
   UPDATE users SET available_spins = available_spins + 1;
   INSERT INTO spin_entitlements (user_id, source_type) VALUES (...);
   ```

2. **å¼€å‘è€…æŽˆäºˆæƒé™**

   ```sql
   -- äº‹åŠ¡ä¸­åŒæ—¶æ‰§è¡Œ
   UPDATE users SET available_spins = 10;
   INSERT INTO spin_entitlements ... (å¾ªçŽ¯10æ¬¡)
   ```

3. **å¿«é€Ÿæ·»åŠ æŠ½å¥–**
   ```sql
   -- äº‹åŠ¡ä¸­åŒæ—¶æ‰§è¡Œ
   UPDATE users SET available_spins = available_spins + 1;
   INSERT INTO spin_entitlements ...
   ```

## âœ… éªŒè¯æ­¥éª¤

ä¿®å¤åŽéªŒè¯ï¼š

```sql
-- 1. æŸ¥çœ‹ users è¡¨
SELECT id, available_spins FROM users WHERE telegram_id = 'ä½ çš„ID';

-- 2. æŸ¥çœ‹ spin_entitlements è¡¨
SELECT COUNT(*) FROM spin_entitlements
WHERE user_id = 'ä½ çš„user_id' AND consumed = false;

-- ä¸¤ä¸ªæ•°å­—åº”è¯¥ä¸€è‡´ï¼
```

## ðŸš€ ä¸‹æ¬¡éƒ¨ç½²åŽ

1. æ‰“å¼€ Telegram Bot
2. ç‚¹å‡» **"ðŸ› ï¸ å¼€å‘è€…"**
3. ç‚¹å‡» **"ðŸ”§ ä¿®å¤æŠ½å¥–æ¬¡æ•°"**
4. çœ‹åˆ°æç¤ºï¼š"å·²åŒæ­¥æ•°æ®ï¼Œåˆ›å»ºäº† 10 æ¡æŠ½å¥–èµ„æ ¼è®°å½•"
5. åˆ·æ–°é¡µé¢
6. **å¯æŠ½å¥–æ¬¡æ•°åº”è¯¥æ˜¾ç¤º 10**
7. ç‚¹å‡»æŠ½å¥–åº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨

## ðŸ“Œ é‡è¦æç¤º

**ä¸è¦æäº¤è¿™æ¬¡ä¿®æ”¹**ï¼ˆæŒ‰ä½ è¦æ±‚ï¼‰

å½“ä½ å‡†å¤‡å¥½æµ‹è¯•æ—¶ï¼š

```bash
# æäº¤ä¿®å¤
git add .
git commit -m "ðŸ”§ ä¿®å¤æŠ½å¥–æ¬¡æ•°æ•°æ®ä¸ä¸€è‡´é—®é¢˜"
git push

# Railway ä¼šè‡ªåŠ¨éƒ¨ç½²
# ç„¶åŽä½¿ç”¨å¼€å‘è€…é¢æ¿çš„"ä¿®å¤æŠ½å¥–æ¬¡æ•°"åŠŸèƒ½
```

---

## ðŸŽ“ æŠ€æœ¯æ€»ç»“

**ä¸ºä»€ä¹ˆä¼šå‡ºçŽ°æ•°æ®ä¸ä¸€è‡´ï¼Ÿ**

å¯èƒ½çš„åŽŸå› ï¼š

1. ç›´æŽ¥ä¿®æ”¹äº† `users.available_spins` ä½†æ²¡åˆ›å»º `spin_entitlements`
2. æµ‹è¯•æ—¶åˆ é™¤äº† `spin_entitlements` è®°å½•ä½†æ²¡æ›´æ–° `users` è¡¨
3. æ—©æœŸç‰ˆæœ¬çš„ä»£ç åªæ›´æ–°äº†ä¸€ä¸ªè¡¨

**é•¿æœŸè§£å†³æ–¹æ¡ˆï¼š**

- ä½¿ç”¨æ•°æ®åº“è§¦å‘å™¨è‡ªåŠ¨åŒæ­¥
- æˆ–è€…åªä¾èµ– `spin_entitlements` è¡¨ï¼ŒåºŸå¼ƒ `users.available_spins` å­—æ®µ
- å®šæœŸè¿è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ä»»åŠ¡
