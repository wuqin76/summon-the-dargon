# ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£é›†æˆæ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å°†ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£é›†æˆåˆ°æ¸¸æˆç³»ç»Ÿä¸­ã€‚

## ğŸ® æ”¯ä»˜æµç¨‹

### 1. ç”¨æˆ·æ¸¸ç©æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç‚¹å‡»æ¸¸ç© â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      Yes    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ æ˜¯å¦ç¬¬ä¸€æ¬¡ç©ï¼Ÿ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ å…è´¹è¿›å…¥æ¸¸æˆ  â”‚
 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ No
        â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ è°ƒç”¨æ”¯ä»˜æ¥å£  â”‚
 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ è·³è½¬æ”¯ä»˜é¡µé¢  â”‚
 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ è½®è¯¢æ”¯ä»˜çŠ¶æ€  â”‚
 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ æ”¯ä»˜æˆåŠŸ
        â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ è¿›å…¥æ¸¸æˆ      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. åç«¯APIæµç¨‹

```
å‰ç«¯                    åç«¯                     ç¬¬ä¸‰æ–¹æ”¯ä»˜
  â”‚                      â”‚                          â”‚
  â”‚  POST /payment/v2/create                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                          â”‚
  â”‚                      â”‚                          â”‚
  â”‚                      â”‚  ç”Ÿæˆè®¢å•ID               â”‚
  â”‚                      â”‚  ä¿å­˜è®¢å•åˆ°æ•°æ®åº“         â”‚
  â”‚                      â”‚                          â”‚
  â”‚                      â”‚  è°ƒç”¨ç¬¬ä¸‰æ–¹APIåˆ›å»ºè®¢å•    â”‚
  â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
  â”‚                      â”‚                          â”‚
  â”‚                      â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚  è¿”å›æ”¯ä»˜URL              â”‚
  â”‚                      â”‚                          â”‚
  â”‚  è¿”å›è®¢å•ä¿¡æ¯+æ”¯ä»˜URLâ”‚                          â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
  â”‚                      â”‚                          â”‚
  â”‚  ç”¨æˆ·åœ¨æ–°çª—å£å®Œæˆæ”¯ä»˜â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â†’â”‚
  â”‚                      â”‚                          â”‚
  â”‚                      â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚  Webhookå›è°ƒé€šçŸ¥          â”‚
  â”‚                      â”‚  æ›´æ–°è®¢å•çŠ¶æ€             â”‚
  â”‚                      â”‚                          â”‚
  â”‚  GET /payment/v2/status/:orderId               â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                          â”‚
  â”‚                      â”‚  æŸ¥è¯¢è®¢å•çŠ¶æ€             â”‚
  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
  â”‚  è¿”å›è®¢å•çŠ¶æ€         â”‚                          â”‚
```

## ğŸ”§ é…ç½®è¯´æ˜

### 1. ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```bash
# ç¬¬ä¸‰æ–¹æ”¯ä»˜é…ç½®
PAYMENT_URL=https://your-payment-provider.com/api/create-order
PAYMENT_API_KEY=your_api_key_here
PAYMENT_WEBHOOK_SECRET=your_webhook_secret_here
PAYMENT_AMOUNT=10

# æ”¯ä»˜å›è°ƒURLï¼ˆéƒ¨ç½²åçš„åŸŸåï¼‰
PAYMENT_CALLBACK_URL=https://your-domain.com/api/webhook/payment
PAYMENT_RETURN_URL=https://your-domain.com/
```

### 2. ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£è¦æ±‚

æ‚¨éœ€è¦å‘æˆ‘æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

#### ğŸ“Œ åˆ›å»ºè®¢å•æ¥å£

- **URL**: `_____________________`
- **è¯·æ±‚æ–¹å¼**: `POST` / `GET`
- **è¯·æ±‚å¤´**:
  ```json
  {
    "Authorization": "Bearer YOUR_API_KEY",
    "Content-Type": "application/json"
  }
  ```
- **è¯·æ±‚å‚æ•°**:
  ```json
  {
    "order_id": "ORDER_1234567890",
    "amount": 10,
    "currency": "USDT",
    "user_id": "user_xxx",
    "callback_url": "https://your-domain.com/api/webhook/payment",
    "return_url": "https://your-domain.com/"
  }
  ```
- **æˆåŠŸå“åº”**:
  ```json
  {
    "code": "0",
    "msg": "success",
    "data": {
      "order_id": "ORDER_1234567890",
      "payment_url": "https://payment-provider.com/pay/xxxx",
      "expires_at": "2024-01-01T12:00:00Z"
    }
  }
  ```
- **å¤±è´¥å“åº”**:
  ```json
  {
    "code": "-1",
    "msg": "fail",
    "data": null
  }
  ```

#### ğŸ“Œ Webhookå›è°ƒæ¥å£

æ”¯ä»˜æˆåŠŸåï¼Œç¬¬ä¸‰æ–¹ä¼šè°ƒç”¨æ‚¨çš„æœåŠ¡å™¨ï¼š

- **URL**: `https://your-domain.com/api/webhook/payment`
- **è¯·æ±‚æ–¹å¼**: `POST`
- **è¯·æ±‚å‚æ•°ç¤ºä¾‹**:
  ```json
  {
    "order_id": "ORDER_1234567890",
    "transaction_id": "TXN_9876543210",
    "status": "success",
    "amount": 10,
    "currency": "USDT",
    "timestamp": "2024-01-01T12:00:00Z",
    "signature": "ç­¾åå­—ç¬¦ä¸²ç”¨äºéªŒè¯"
  }
  ```

#### ğŸ“Œ æŸ¥è¯¢è®¢å•çŠ¶æ€æ¥å£ï¼ˆå¯é€‰ï¼‰

å¦‚æœç¬¬ä¸‰æ–¹æä¾›æŸ¥è¯¢æ¥å£ï¼š

- **URL**: `https://payment-provider.com/api/query-order`
- **è¯·æ±‚æ–¹å¼**: `POST` / `GET`
- **è¯·æ±‚å‚æ•°**:
  ```json
  {
    "order_id": "ORDER_1234567890"
  }
  ```
- **å“åº”æ ¼å¼**:
  ```json
  {
    "code": "0",
    "data": {
      "order_id": "ORDER_1234567890",
      "status": "success" | "pending" | "failed",
      "amount": 10
    }
  }
  ```

## ğŸ’» ä»£ç å®ç°

### 1. å‰ç«¯ä»£ç ï¼ˆå·²å®ç°ï¼‰

ä½ç½®ï¼š`public/index.html`

å…³é”®å‡½æ•°ï¼š

- `handleFirstPlay()` - æ£€æŸ¥æ˜¯å¦ç¬¬ä¸€æ¬¡æ¸¸ç©
- `handlePaidMode()` - åˆ›å»ºæ”¯ä»˜è®¢å•å¹¶è·³è½¬
- `startPaymentStatusPolling()` - è½®è¯¢æ”¯ä»˜çŠ¶æ€
- `handlePaymentSuccess()` - æ”¯ä»˜æˆåŠŸå¤„ç†

### 2. åç«¯ä»£ç ï¼ˆéœ€è¦å®Œå–„ï¼‰

ä½ç½®ï¼š`src/routes/payment_v2.routes.ts`

éœ€è¦å®ç°çš„å‡½æ•°ï¼š

```typescript
// è°ƒç”¨ç¬¬ä¸‰æ–¹APIåˆ›å»ºè®¢å•
async function createThirdPartyOrder(
  orderId: string,
  amount: number,
  userId: string
) {
  const response = await fetch(process.env.PAYMENT_URL!, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${process.env.PAYMENT_API_KEY}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      order_id: orderId,
      amount,
      currency: "USDT",
      user_id: userId,
      callback_url: `${process.env.PAYMENT_CALLBACK_URL}`,
      return_url: `${process.env.PAYMENT_RETURN_URL}`,
    }),
  });

  const data = await response.json();

  if (data.code === "0" || data.code === 0) {
    return {
      success: true,
      payment_url: data.data.payment_url,
      order_id: data.data.order_id,
    };
  } else {
    throw new Error(data.msg || "åˆ›å»ºè®¢å•å¤±è´¥");
  }
}
```

## ğŸ“ å¾…åŠäº‹é¡¹

### è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

- [ ] âœ… ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£URL
- [ ] âœ… APIå¯†é’¥æˆ–è®¤è¯æ–¹å¼
- [ ] âœ… åˆ›å»ºè®¢å•çš„è¯·æ±‚å‚æ•°æ ¼å¼
- [ ] âœ… æˆåŠŸ/å¤±è´¥çš„å“åº”æ ¼å¼
- [ ] âœ… Webhookå›è°ƒçš„å‚æ•°æ ¼å¼
- [ ] âœ… ç­¾åéªŒè¯ç®—æ³•ï¼ˆå¦‚æœæœ‰ï¼‰
- [ ] âœ… æŸ¥è¯¢è®¢å•çŠ¶æ€æ¥å£ï¼ˆå¦‚æœæœ‰ï¼‰

### æ”¶åˆ°ä¿¡æ¯åæˆ‘ä¼šï¼š

1. âœ… å®ç° `createThirdPartyOrder()` å‡½æ•°
2. âœ… å®Œå–„ Webhook å¤„ç†é€»è¾‘
3. âœ… æ·»åŠ ç­¾åéªŒè¯
4. âœ… å®ç°è®¢å•çŠ¶æ€æŸ¥è¯¢
5. âœ… æ·»åŠ é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ç­¾åéªŒè¯**: å¿…é¡»éªŒè¯Webhookå›è°ƒçš„ç­¾åï¼Œé˜²æ­¢ä¼ªé€ è¯·æ±‚
2. **å¹‚ç­‰æ€§**: Webhookå¯èƒ½ä¼šé‡å¤è°ƒç”¨ï¼Œéœ€è¦ä¿è¯å¹‚ç­‰æ€§
3. **è¶…æ—¶å¤„ç†**: æ”¯ä»˜è®¢å•åº”è¯¥æœ‰è¿‡æœŸæ—¶é—´
4. **æ—¥å¿—è®°å½•**: è®°å½•æ‰€æœ‰æ”¯ä»˜ç›¸å…³çš„æ“ä½œæ—¥å¿—
5. **é”™è¯¯å¤„ç†**: å¦¥å–„å¤„ç†æ”¯ä»˜å¤±è´¥çš„æƒ…å†µ

## ğŸ“ ä¸‹ä¸€æ­¥

è¯·æä¾›ä¸Šè¿°ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£çš„è¯¦ç»†ä¿¡æ¯ï¼Œæˆ‘å°†å®Œæˆä»¥ä¸‹å·¥ä½œï¼š

1. å®ç°å®Œæ•´çš„æ”¯ä»˜æ¥å£è°ƒç”¨
2. é…ç½®Webhookå¤„ç†
3. æ·»åŠ æ”¯ä»˜çŠ¶æ€è½®è¯¢
4. æµ‹è¯•æ•´ä¸ªæ”¯ä»˜æµç¨‹
5. æä¾›æµ‹è¯•æŒ‡å—

## ğŸ§ª æµ‹è¯•å»ºè®®

1. **æµ‹è¯•ç¯å¢ƒ**: å…ˆåœ¨æµ‹è¯•ç¯å¢ƒå®Œæˆé›†æˆæµ‹è¯•
2. **æ¨¡æ‹Ÿæ”¯ä»˜**: å¯ä»¥ä½¿ç”¨æ¨¡æ‹Ÿæ¥å£æµ‹è¯•æµç¨‹
3. **è¾¹ç•Œæƒ…å†µ**: æµ‹è¯•æ”¯ä»˜è¶…æ—¶ã€å¤±è´¥ã€é‡å¤å›è°ƒç­‰æƒ…å†µ
4. **æ€§èƒ½æµ‹è¯•**: æµ‹è¯•é«˜å¹¶å‘ä¸‹çš„æ”¯ä»˜å¤„ç†èƒ½åŠ›
