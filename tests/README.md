# é‚€è¯·åŠŸèƒ½æµ‹è¯•æŒ‡å—

## æ¦‚è¿°

æœ¬é¡¹ç›®å·²ç»å®Œæˆäº†é‚€è¯·åŠŸèƒ½çš„æµ‹è¯•æ–‡ä»¶ç¼–å†™ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ã€‚åŒæ—¶å‰ç«¯ä¹Ÿå·²ç»æ·»åŠ äº†å¯æŠ½å¥–æ¬¡æ•°çš„æ˜¾ç¤ºåŠŸèƒ½ã€‚

## æµ‹è¯•å†…å®¹

### 1. é‚€è¯·åŠŸèƒ½æ ¸å¿ƒæµ‹è¯• (`tests/invite.test.ts`)

æµ‹è¯•æ–‡ä»¶åŒ…å«ä»¥ä¸‹æµ‹è¯•å¥—ä»¶ï¼š

#### å•å…ƒæµ‹è¯•

- **handleInviteRegistration** - é‚€è¯·æ³¨å†Œå¤„ç†
  - âœ… æˆåŠŸåˆ›å»ºé‚€è¯·è®°å½•å¹¶ç»™é‚€è¯·è€…å¢åŠ æŠ½å¥–æœºä¼š
  - âœ… åœ¨å‡ºé”™æ—¶æŠ›å‡ºå¼‚å¸¸

- **updateInviteeAction** - æ›´æ–°è¢«é‚€è¯·äººè¡Œä¸º
  - âœ… æ›´æ–°è¢«é‚€è¯·äººçš„ä»˜è´¹æ¸¸ç©çŠ¶æ€
  - âœ… æ›´æ–°è¢«é‚€è¯·äººçš„é‚€è¯·ä»–äººçŠ¶æ€

#### é›†æˆæµ‹è¯•

- **é‚€è¯·åŠŸèƒ½é›†æˆæµ‹è¯•**
  - âœ… å®Œæ•´æµ‹è¯•é‚€è¯·æµç¨‹ï¼šæ–°ç”¨æˆ·é€šè¿‡é‚€è¯·ç æ³¨å†Œï¼Œé‚€è¯·è€…è·å¾—æŠ½å¥–æœºä¼š
  - âœ… æµ‹è¯•é‡å¤é‚€è¯·æ£€æµ‹ï¼šåŒä¸€ç”¨æˆ·ä¸èƒ½è¢«å¤šæ¬¡é‚€è¯·
  - âœ… æµ‹è¯•è‡ªæˆ‘é‚€è¯·æ£€æµ‹ï¼šç”¨æˆ·ä¸èƒ½ä½¿ç”¨è‡ªå·±çš„é‚€è¯·ç 

- **é‚€è¯·ç»Ÿè®¡åŠŸèƒ½æµ‹è¯•**
  - âœ… æ­£ç¡®ç»Ÿè®¡é‚€è¯·äººæ•°
  - âœ… éªŒè¯æŠ½å¥–æ¬¡æ•°å¢åŠ 
  - âœ… éªŒè¯æŠ½å¥–èµ„æ ¼è®°å½•

#### APIç«¯ç‚¹æµ‹è¯•ï¼ˆå ä½ç¬¦ï¼‰

- GET /api/invite/info
- POST /api/invite/accept
- GET /api/invite/stats
- GET /api/invite/list

## è¿è¡Œæµ‹è¯•

### å‰ç½®æ¡ä»¶

1. å®‰è£…ä¾èµ–ï¼š

```bash
npm install
```

2. è®¾ç½®æµ‹è¯•æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰ï¼š

```bash
export TEST_DATABASE_URL="postgresql://localhost:5432/test_db"
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
npm test
```

### è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶

```bash
npm test tests/invite.test.ts
```

### è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
npm test -- --coverage
```

### ç›‘å¬æ¨¡å¼ï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰

```bash
npm test -- --watch
```

## å‰ç«¯åŠŸèƒ½éªŒè¯

### å¯æŠ½å¥–æ¬¡æ•°æ˜¾ç¤º

å‰ç«¯å·²ç»æ·»åŠ äº†å¯æŠ½å¥–æ¬¡æ•°çš„æ˜¾ç¤ºåŠŸèƒ½ï¼š

1. **æ˜¾ç¤ºä½ç½®**ï¼šåœ¨é¡µé¢é¡¶éƒ¨çš„é‚€è¯·åŒºåŸŸ
2. **æ˜¾ç¤ºæ ·å¼**ï¼š`ğŸ² å¯æŠ½å¥–æ¬¡æ•°: [æ•°å­—]`
3. **è‡ªåŠ¨æ›´æ–°**ï¼š
   - é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½
   - é‚€è¯·å¥½å‹åæ›´æ–°
   - å®ŒæˆæŠ½å¥–åæ›´æ–°
   - å¼€å‘è€…é¢æ¿æ“ä½œåæ›´æ–°

### æµ‹è¯•å‰ç«¯åŠŸèƒ½

1. æ‰“å¼€åº”ç”¨é¦–é¡µ
2. æŸ¥çœ‹é¡¶éƒ¨æ˜¯å¦æ˜¾ç¤º "ğŸ² å¯æŠ½å¥–æ¬¡æ•°: 0"
3. é‚€è¯·å¥½å‹åï¼Œè¯¥æ•°å­—åº”è¯¥å¢åŠ 
4. å®ŒæˆæŠ½å¥–åï¼Œè¯¥æ•°å­—åº”è¯¥å‡å°‘

## é‚€è¯·åŠŸèƒ½éªŒè¯æ¸…å•

### åç«¯åŠŸèƒ½

- [x] é‚€è¯·æ³¨å†Œå¤„ç†å‡½æ•°æ­£ç¡®
- [x] åˆ›å»ºé‚€è¯·è®°å½•
- [x] ç»™é‚€è¯·è€…å¢åŠ  available_spins
- [x] åˆ›å»ºæŠ½å¥–èµ„æ ¼è®°å½•ï¼ˆspin_entitlementsï¼‰
- [x] æ›´æ–°é‚€è¯·ç»Ÿè®¡
- [x] é˜²æ­¢é‡å¤é‚€è¯·
- [x] é˜²æ­¢è‡ªæˆ‘é‚€è¯·

### å‰ç«¯åŠŸèƒ½

- [x] æ˜¾ç¤ºå¯æŠ½å¥–æ¬¡æ•°
- [x] é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–
- [x] é‚€è¯·åè‡ªåŠ¨æ›´æ–°
- [x] æŠ½å¥–åè‡ªåŠ¨æ›´æ–°
- [x] å¼€å‘è€…é¢æ¿æ˜¾ç¤º

### æ•°æ®åº“

- [x] users.available_spins å­—æ®µå­˜åœ¨
- [x] spin_entitlements è¡¨å­˜åœ¨
- [x] invitations è¡¨å­˜åœ¨
- [x] æ­£ç¡®çš„å¤–é”®çº¦æŸ

## æ ¸å¿ƒæµç¨‹è¯´æ˜

### é‚€è¯·æµç¨‹

1. **ç”¨æˆ·Aç”Ÿæˆé‚€è¯·é“¾æ¥**
   - GET /api/invite/info
   - è·å–é‚€è¯·ç å’Œé“¾æ¥

2. **ç”¨æˆ·Bé€šè¿‡é‚€è¯·é“¾æ¥æ³¨å†Œ**
   - Telegramå¯åŠ¨å‚æ•°åŒ…å«é‚€è¯·ç 
   - ç”¨æˆ·Bç™»å½•æ—¶æ£€æµ‹åˆ°é‚€è¯·ç 
   - POST /api/invite/accept

3. **ç³»ç»Ÿå¤„ç†é‚€è¯·**
   - éªŒè¯é‚€è¯·ç æœ‰æ•ˆæ€§
   - æ£€æŸ¥æ˜¯å¦é‡å¤é‚€è¯·
   - è°ƒç”¨ handleInviteRegistration()
     - åˆ›å»º invitations è®°å½•
     - æ›´æ–°ç”¨æˆ·Açš„ total_invited
     - åˆ›å»º spin_entitlements è®°å½•ï¼ˆsource_type: 'invite'ï¼‰
     - ç”¨æˆ·Açš„ available_spins +1

4. **ç”¨æˆ·Aå¯ä»¥è¿›è¡ŒæŠ½å¥–**
   - GET /api/spin/available æŸ¥çœ‹å¯ç”¨æ¬¡æ•°
   - POST /api/spin/execute æ‰§è¡ŒæŠ½å¥–
   - æ¶ˆè€—ä¸€ä¸ª spin_entitlement
   - available_spins -1

## æµ‹è¯•æ•°æ®åº“è®¾ç½®

### å•å…ƒæµ‹è¯•ï¼ˆæ— éœ€æ•°æ®åº“ï¼‰

å•å…ƒæµ‹è¯•ä½¿ç”¨ mock å¯¹è±¡ï¼Œä¸éœ€è¦çœŸå®æ•°æ®åº“è¿æ¥ã€‚å¯ä»¥ç›´æ¥è¿è¡Œï¼š

```bash
npm test tests/invite.test.ts
```

### é›†æˆæµ‹è¯•ï¼ˆéœ€è¦æ•°æ®åº“ï¼‰

å¦‚æœéœ€è¦è¿è¡Œå®Œæ•´çš„é›†æˆæµ‹è¯•ï¼ˆå½“å‰è¢«æ ‡è®°ä¸º `skip`ï¼‰ï¼Œéœ€è¦é…ç½®æµ‹è¯•æ•°æ®åº“ï¼š

1. åˆ›å»ºæµ‹è¯•æ•°æ®åº“ï¼š

```sql
-- åˆ›å»ºæµ‹è¯•æ•°æ®åº“
CREATE DATABASE test_db;
```

2. åº”ç”¨æ•°æ®åº“æ¶æ„ï¼š

```sql
-- ä½¿ç”¨ä¸ä¸»æ•°æ®åº“ç›¸åŒçš„schema
-- å‚è€ƒ database/schema_v2.sql
```

3. è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```bash
# Windows PowerShell
$env:TEST_DATABASE_URL="postgresql://username:password@localhost:5432/test_db"
```

4. åœ¨æµ‹è¯•æ–‡ä»¶ä¸­ç§»é™¤ `.skip` æ ‡è®°ï¼š

```typescript
// å°† it.skip æ”¹ä¸º it
it('å®Œæ•´æµ‹è¯•é‚€è¯·æµç¨‹...', async () => {
```

## å¸¸è§é—®é¢˜

### Q: æµ‹è¯•å¤±è´¥ï¼Œæç¤ºæ•°æ®åº“è¿æ¥é”™è¯¯

A: ç¡®ä¿è®¾ç½®äº†æ­£ç¡®çš„ TEST_DATABASE_URL ç¯å¢ƒå˜é‡

### Q: å‰ç«¯ä¸æ˜¾ç¤ºå¯æŠ½å¥–æ¬¡æ•°

A: æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ï¼Œç¡®è®¤ API è°ƒç”¨æˆåŠŸä¸”è¿”å›æ•°æ®æ­£ç¡®

### Q: æŠ½å¥–æ¬¡æ•°ä¸æ›´æ–°

A: æ£€æŸ¥ loadAvailableSpins() å‡½æ•°æ˜¯å¦åœ¨å…³é”®æ“ä½œåè¢«è°ƒç”¨

## ç›¸å…³æ–‡ä»¶

- æµ‹è¯•æ–‡ä»¶ï¼š`tests/invite.test.ts`
- Jesté…ç½®ï¼š`jest.config.json`
- æµ‹è¯•è®¾ç½®ï¼š`tests/setup.ts`
- é‚€è¯·è·¯ç”±ï¼š`src/routes/invite.routes.ts`
- å‰ç«¯é¡µé¢ï¼š`public/index.html`

## æ›´å¤šæµ‹è¯•

å»ºè®®æ·»åŠ ä»¥ä¸‹é¢å¤–æµ‹è¯•ï¼ˆæœªæ¥å·¥ä½œï¼‰ï¼š

1. **æ€§èƒ½æµ‹è¯•**ï¼šå¤§é‡é‚€è¯·çš„æ€§èƒ½è¡¨ç°
2. **å¹¶å‘æµ‹è¯•**ï¼šåŒæ—¶å¤„ç†å¤šä¸ªé‚€è¯·è¯·æ±‚
3. **APIç«¯ç‚¹æµ‹è¯•**ï¼šä½¿ç”¨ supertest æµ‹è¯•å®é™…HTTPè¯·æ±‚
4. **ç«¯åˆ°ç«¯æµ‹è¯•**ï¼šä½¿ç”¨ Playwright æˆ– Cypress æµ‹è¯•å®Œæ•´ç”¨æˆ·æµç¨‹
5. **è¾¹ç•Œæµ‹è¯•**ï¼šæµ‹è¯•æç«¯æƒ…å†µå’Œè¾¹ç•Œå€¼

## æŒç»­é›†æˆ

å»ºè®®åœ¨ CI/CD æµç¨‹ä¸­åŠ å…¥æµ‹è¯•ï¼š

```yaml
# .github/workflows/test.yml ç¤ºä¾‹
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v2
        with:
          node-version: "18"
      - run: npm install
      - run: npm test -- --coverage
```
