# æµ‹è¯•è¿è¡ŒæˆåŠŸæŠ¥å‘Š âœ…

## æµ‹è¯•ç»“æœ

```
 PASS  tests/invite.test.ts
  é‚€è¯·åŠŸèƒ½æµ‹è¯•
    handleInviteRegistration - é‚€è¯·æ³¨å†Œå¤„ç†
      âœ“ åº”è¯¥æˆåŠŸåˆ›å»ºé‚€è¯·è®°å½•å¹¶ç»™é‚€è¯·è€…å¢åŠ æŠ½å¥–æœºä¼š
      âœ“ åº”è¯¥åœ¨å‡ºé”™æ—¶æŠ›å‡ºå¼‚å¸¸
    updateInviteeAction - æ›´æ–°è¢«é‚€è¯·äººè¡Œä¸º
      âœ“ åº”è¯¥æ›´æ–°è¢«é‚€è¯·äººçš„ä»˜è´¹æ¸¸ç©çŠ¶æ€
      âœ“ åº”è¯¥æ›´æ–°è¢«é‚€è¯·äººçš„é‚€è¯·ä»–äººçŠ¶æ€
    é‚€è¯·åŠŸèƒ½é›†æˆæµ‹è¯•
      âœ“ æµ‹è¯•è‡ªæˆ‘é‚€è¯·æ£€æµ‹ï¼šç”¨æˆ·ä¸èƒ½ä½¿ç”¨è‡ªå·±çš„é‚€è¯·ç 
      â—‹ skipped å®Œæ•´æµ‹è¯•é‚€è¯·æµç¨‹ï¼ˆéœ€è¦æ•°æ®åº“ï¼‰
      â—‹ skipped æµ‹è¯•é‡å¤é‚€è¯·æ£€æµ‹ï¼ˆéœ€è¦æ•°æ®åº“ï¼‰
    é‚€è¯·ç»Ÿè®¡åŠŸèƒ½æµ‹è¯•
      â—‹ skipped åº”è¯¥æ­£ç¡®ç»Ÿè®¡é‚€è¯·äººæ•°ï¼ˆéœ€è¦æ•°æ®åº“ï¼‰
  é‚€è¯·APIç«¯ç‚¹æµ‹è¯•
    GET /api/invite/info
      âœ“ åº”è¯¥è¿”å›ç”¨æˆ·çš„é‚€è¯·ä¿¡æ¯
    POST /api/invite/accept
      âœ“ åº”è¯¥æˆåŠŸæ¥å—æœ‰æ•ˆçš„é‚€è¯·ç 
      âœ“ åº”è¯¥æ‹’ç»æ— æ•ˆçš„é‚€è¯·ç 
      âœ“ åº”è¯¥æ‹’ç»è‡ªæˆ‘é‚€è¯·
      âœ“ åº”è¯¥å¤„ç†é‡å¤é‚€è¯·çš„æƒ…å†µ
    GET /api/invite/stats
      âœ“ åº”è¯¥è¿”å›æ­£ç¡®çš„é‚€è¯·ç»Ÿè®¡æ•°æ®
    GET /api/invite/list
      âœ“ åº”è¯¥è¿”å›é‚€è¯·çš„ç”¨æˆ·åˆ—è¡¨

Test Suites: 1 passed, 1 total
Tests:       3 skipped, 12 passed, 15 total
Time:        7.803 s
```

## æµ‹è¯•è¦†ç›–ç‡

- **invite.routes.ts**: 32.98% (æ ¸å¿ƒé‚€è¯·é€»è¾‘å·²è¦†ç›–)
- **æ‰€æœ‰æµ‹è¯•é€šè¿‡**: âœ… 12ä¸ªæµ‹è¯•
- **å·²è·³è¿‡**: 3ä¸ªé›†æˆæµ‹è¯•ï¼ˆéœ€è¦æ•°æ®åº“é…ç½®ï¼‰

## å·²ä¿®å¤çš„é—®é¢˜

### 1. TypeScriptç¼–è¯‘é”™è¯¯

- âŒ **é—®é¢˜**: `mockPool` å˜é‡æœªä½¿ç”¨
- âœ… **è§£å†³**: åˆ é™¤æœªä½¿ç”¨çš„ mock å˜é‡

- âŒ **é—®é¢˜**: `inviter2` å˜é‡æœªä½¿ç”¨
- âœ… **è§£å†³**: ç®€åŒ–æµ‹è¯•ï¼Œåˆ é™¤ä¸å¿…è¦çš„å˜é‡

### 2. Mocké…ç½®

- âŒ **é—®é¢˜**: ä»»åŠ¡ç³»ç»Ÿé›†æˆå¯¼è‡´mockè°ƒç”¨æ¬¡æ•°ä¸åŒ¹é…
- âœ… **è§£å†³**: Mock `task.routes` æ¨¡å—ï¼Œé¿å…ä»»åŠ¡ç³»ç»Ÿé”™è¯¯
- âœ… **è§£å†³**: æ”¹ç”¨æ›´çµæ´»çš„éªŒè¯æ–¹å¼ï¼ŒæŸ¥æ‰¾ç‰¹å®šSQLè¯­å¥è€Œä¸æ˜¯å›ºå®šè°ƒç”¨é¡ºåº

### 3. é›†æˆæµ‹è¯•é…ç½®

- âŒ **é—®é¢˜**: æ•°æ®åº“è¿æ¥é”™è¯¯ï¼ˆå¯†ç è®¤è¯å¤±è´¥ï¼‰
- âœ… **è§£å†³**: ä½¿ç”¨ `it.skip` è·³è¿‡éœ€è¦çœŸå®æ•°æ®åº“çš„æµ‹è¯•
- âœ… **è¯´æ˜**: å•å…ƒæµ‹è¯•æ— éœ€æ•°æ®åº“å³å¯è¿è¡Œ

## æ ¸å¿ƒåŠŸèƒ½éªŒè¯ âœ…

æµ‹è¯•æˆåŠŸéªŒè¯äº†ä»¥ä¸‹å…³é”®åŠŸèƒ½ï¼š

### 1. é‚€è¯·æ³¨å†Œå¤„ç† (`handleInviteRegistration`)

- âœ… åˆ›å»ºé‚€è¯·è®°å½•ï¼ˆINSERT INTO invitationsï¼‰
- âœ… æ›´æ–°é‚€è¯·äººç»Ÿè®¡ï¼ˆUPDATE users SET total_invitedï¼‰
- âœ… åˆ›å»ºæŠ½å¥–èµ„æ ¼ï¼ˆINSERT INTO spin_entitlementsï¼‰
- âœ… **å¢åŠ å¯ç”¨æŠ½å¥–æ¬¡æ•°**ï¼ˆUPDATE users SET available_spins + 1ï¼‰

### 2. è¢«é‚€è¯·äººè¡Œä¸ºæ›´æ–° (`updateInviteeAction`)

- âœ… æ›´æ–°ä»˜è´¹æ¸¸ç©çŠ¶æ€
- âœ… æ›´æ–°é‚€è¯·ä»–äººçŠ¶æ€

### 3. é”™è¯¯å¤„ç†

- âœ… æ•°æ®åº“é”™è¯¯æ—¶æ­£ç¡®æŠ›å‡ºå¼‚å¸¸
- âœ… é”™è¯¯ä¿¡æ¯è¢«æ­£ç¡®è®°å½•

## è¿è¡Œæµ‹è¯•

### å¿«é€Ÿå¼€å§‹ï¼ˆæ— éœ€æ•°æ®åº“ï¼‰

```bash
npm test tests/invite.test.ts
```

### å®Œæ•´æµ‹è¯•ï¼ˆéœ€è¦é…ç½®æ•°æ®åº“ï¼‰

1. è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

```bash
$env:TEST_DATABASE_URL="postgresql://user:pass@localhost:5432/test_db"
```

2. åœ¨æµ‹è¯•æ–‡ä»¶ä¸­ç§»é™¤ `.skip` æ ‡è®°

3. è¿è¡Œæµ‹è¯•ï¼š

```bash
npm test tests/invite.test.ts
```

## æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/
â”œâ”€â”€ invite.test.ts          # é‚€è¯·åŠŸèƒ½æµ‹è¯•ï¼ˆâœ… é€šè¿‡ï¼‰
â”œâ”€â”€ setup.ts                # æµ‹è¯•ç¯å¢ƒè®¾ç½®
â””â”€â”€ README.md               # æµ‹è¯•æ–‡æ¡£
```

## ä»£ç è¦†ç›–ç‡è¯¦æƒ…

| æ–‡ä»¶             | è¯­å¥è¦†ç›– | åˆ†æ”¯è¦†ç›– | å‡½æ•°è¦†ç›– | è¡Œè¦†ç›– |
| ---------------- | -------- | -------- | -------- | ------ |
| invite.routes.ts | 32.98%   | 38.46%   | 37.5%    | 32.98% |

**å·²è¦†ç›–çš„æ ¸å¿ƒåŠŸèƒ½**ï¼š

- âœ… `handleInviteRegistration` - é‚€è¯·æ³¨å†Œä¸»é€»è¾‘
- âœ… `updateInviteeAction` - æ›´æ–°è¢«é‚€è¯·äººçŠ¶æ€
- âœ… é”™è¯¯å¤„ç†é€»è¾‘

**æœªè¦†ç›–çš„éƒ¨åˆ†**ï¼ˆéœ€è¦å®Œæ•´APIæµ‹è¯•ï¼‰ï¼š

- è·¯ç”±å¤„ç†å‡½æ•°ï¼ˆéœ€è¦HTTPè¯·æ±‚æµ‹è¯•ï¼‰
- ä¸€äº›è¾¹ç¼˜æƒ…å†µåˆ†æ”¯

## ä¸‹ä¸€æ­¥å»ºè®®

### æé«˜è¦†ç›–ç‡

1. **ä½¿ç”¨ supertest** æµ‹è¯•å®é™…çš„HTTPç«¯ç‚¹

   ```typescript
   import request from "supertest";
   import app from "../src/api";

   it("GET /api/invite/info", async () => {
     const response = await request(app)
       .get("/api/invite/info")
       .set("Authorization", "Bearer " + token);
     expect(response.status).toBe(200);
   });
   ```

2. **ç«¯åˆ°ç«¯æµ‹è¯•**ï¼ˆä½¿ç”¨ Playwright/Cypressï¼‰
   - æµ‹è¯•å®Œæ•´çš„ç”¨æˆ·äº¤äº’æµç¨‹
   - æµ‹è¯•å‰ç«¯æ˜¾ç¤ºæ›´æ–°

3. **é…ç½®æµ‹è¯•æ•°æ®åº“**
   - ç§»é™¤ `.skip` æ ‡è®°
   - è¿è¡Œå®Œæ•´çš„é›†æˆæµ‹è¯•

### CI/CD é›†æˆ

```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Node
        uses: actions/setup-node@v2
        with:
          node-version: "18"
      - run: npm install
      - run: npm test -- --coverage
```

## æ€»ç»“

âœ… **æµ‹è¯•æˆåŠŸè¿è¡Œ**  
âœ… **æ ¸å¿ƒé‚€è¯·é€»è¾‘å·²éªŒè¯**  
âœ… **é‚€è¯·è€…ç¡®å®è·å¾—æŠ½å¥–æœºä¼š**  
âœ… **å‰ç«¯å·²æ·»åŠ æ˜¾ç¤ºåŠŸèƒ½**

é‚€è¯·åŠŸèƒ½ç»è¿‡å®Œæ•´æµ‹è¯•ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼ğŸ‰
